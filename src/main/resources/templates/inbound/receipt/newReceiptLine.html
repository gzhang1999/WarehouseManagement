<!DOCTYPE html>
<!--
* CoreUI - Free Bootstrap Admin Template
* @version v2.0.0
* @link https://coreui.io
* Copyright (c) 2018 creativeLabs Łukasz Holeczek
* Licensed under MIT (https://coreui.io/license)
-->

<!--
* gzhang - Warehouse Management System
* @version v0.0.1
* @link
* Copyright (c) 2018 Gary Zhang
* Licensed under MIT (https://github.com/gzhang1999/WarehouseManagement/blob/master/LICENSE)
-->

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragment/header :: common-head">
</head>
<body class="app header-fixed sidebar-fixed aside-menu-fixed sidebar-lg-show">

<div th:replace="fragment/topNav :: headerNav">
</div>
<div class="app-body">


    <div th:replace="fragment/leftNav :: sidebar">
    </div>
    <main class="main">
        <!-- Breadcrumb-->

        <ol th:replace="fragment/breadcrumb :: breadcrumb"></ol>

        <div class="container-fluid">
            <div class="animated fadeIn">
                <div class="card">

                    <form method="post" enctype="multipart/form-data"  >

                        <div class="card-header" >
                            <span th:text="#{receipt.line.new}"></span>
                            <a class="badge badge-success float-right" th:href="@{'~' + ${flowExecutionUrl} + '&_eventId_home'}" th:text="#{flow.return.home}" >Return Hom</a>

                        </div>
                        <div class="card-body">
                            <!-- Display the trailer and its receipt if we are from 'creating trailer' process -->
                            <div class="card" th:if="${addTrailerFlowModel != null}">
                                <!-- Display the trailer information -->
                                <div class="card-header" id="trailerHeader" role="tab">
                                    <h5 class="mb-0">
                                        <a class="collapsed" data-toggle="collapse" href="#trailerInfo" aria-expanded="false"
                                           aria-controls="trailerInfo" th:text="#{trailer.info}">Trailer Info</a>
                                    </h5>
                                </div>
                                <div class="collapse" id="trailerInfo" role="tabpanel" aria-labelledby="trailerHeader">
                                    <div class="card-body">
                                        <ul class="row">
                                            <li class="col-xs-6 col-sm-4 col-md-3">
                                                <span th:text="#{trailer.number}">Trailer Number</span>:
                                                <span th:text="${addTrailerFlowModel.trailer.trailerNumber}"></span>
                                            </li>
                                            <li class="col-xs-6 col-sm-4 col-md-3">
                                               <span th:text="#{trailer.type}">Type</span>:
                                               <span th:text="${addTrailerFlowModel.trailer.trailerType}"></span>
                                            </li>
                                            <li class="col-xs-6 col-sm-4 col-md-3">
                                                <span th:text="#{trailer.driver}">Driver</span>:
                                                <span th:text="${addTrailerFlowModel.trailer.driver}"></span>
                                            </li>
                                            <li class="col-xs-6 col-sm-4 col-md-3">
                                                <span th:text="#{trailer.driver.telephone}">Driver Telephone</span>:
                                                <span th:text="${addTrailerFlowModel.trailer.driverTelephone}"></span>
                                            </li>
                                            <li class="col-xs-6 col-sm-4 col-md-3">
                                                <span th:text="#{trailer.licensePlate}">License Plate</span>:
                                                <span th:text="${addTrailerFlowModel.trailer.licensePlate}"></span>
                                            </li>
                                            <li class="col-xs-6 col-sm-4 col-md-3">
                                                <span th:text="#{carrier}">carrier</span>:
                                                <span th:text="${addTrailerFlowModel.trailer.carrier.description}"></span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <!-- Display current receipt information -->
                                <div class="card-header" id="receiptHeader" role="tab">
                                    <h5 class="mb-0">
                                        <a data-toggle="collapse" href="#receiptInfo" aria-expanded="true"
                                           aria-controls="receiptInfo" th:text="#{receipt.info}">Receipt Info</a>
                                    </h5>
                                </div>
                                <div class="collapse show" id="receiptInfo" role="tabpanel" aria-labelledby="receiptHeader">
                                    <div class="card-body">
                                        <ul class="row">
                                            <li class="col-xs-6 col-sm-4 col-md-3">
                                                <span th:text="#{receipt.number}">Receipt Number</span>:
                                                <span th:if="${addTrailerFlowModel != null}" th:text="${addTrailerFlowModel.currentReceipt.number}"></span>
                                                <span th:if="${addReceiptFlowModel != null}" th:text="${addReceiptFlowModel.currentReceipt.number}"></span>
                                            </li>
                                            <li class="col-xs-6 col-sm-4 col-md-3">
                                                <span th:text="#{receipt.externalID}">External ID</span>:
                                                <span th:if="${addTrailerFlowModel != null}" th:text="${addTrailerFlowModel.currentReceipt.externalID}"></span>
                                                <span th:if="${addReceiptFlowModel != null}" th:text="${addReceiptFlowModel.currentReceipt.externalID}"></span>
                                            </li>
                                            <li class="col-xs-6 col-sm-4 col-md-3">
                                                <span th:text="#{receipt.purchaseOrderNumber}">Purchase Order Number</span>:
                                                <span th:if="${addTrailerFlowModel != null}" th:text="${addTrailerFlowModel.currentReceipt.purchaseOrderNumber}"></span>
                                                <span th:if="${addReceiptFlowModel != null}" th:text="${addReceiptFlowModel.currentReceipt.purchaseOrderNumber}"></span>
                                            </li>
                                            <li class="col-xs-6 col-sm-4 col-md-3">
                                                <span th:text="#{receipt.supplier}">Supplier</span>:
                                                <span th:if="${addTrailerFlowModel != null}" th:text="${addTrailerFlowModel.currentReceipt.supplier == null ? '' : addTrailerFlowModel.currentReceipt.supplier.description}"></span>
                                                <span th:if="${addReceiptFlowModel != null}" th:text="${addReceiptFlowModel.currentReceipt.supplier == null ? '' : addReceiptFlowModel.currentReceipt.supplier.description}"></span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <a class="collapsed" th:text="#{receipt.line.info}">Receipt Line Info</a>
                                        <button  id="btnClearReceiptLineInfo" type="button" class="btn btn-sm btn-primary float-right" th:text="#{clear}">
                                            Clear</button>
                                    </h5>
                                </div>
                                <div class="card-body">

                                    <div class="form-inline">
                                        <div class="form-group mx-4 my-2">
                                            <label for="lineNumber" class="col-form-label mx-4" th:text="#{receipt.line.number}">Receipt Line Number:</label>
                                            <input type="text" class="form-control" id="lineNumber" name="lineNumber" >
                                        </div>
                                        <div class="form-group mx-4 my-2">
                                            <label for="externalID" class="col-form-label mx-4" th:text="#{receipt.line.externalID}">External ID:</label>
                                            <input type="text" class="form-control" id="externalID" name="externalID" >
                                        </div>
                                        <div class="form-group mx-4 my-2">
                                            <label for="item" class="col-form-label mx-4" th:text="#{receipt.line.item}">item:</label>
                                            <input type="text" class="form-control"  id="item" name="item"  data-controltype="lookup" data-variable="item">
                                        </div>
                                        <div class="form-group mx-4 my-2">
                                            <label for="expectedQuantity" class="col-form-label mx-4" th:text="#{receipt.line.expectedQuantity}">Expected Quantity:</label>
                                            <input type="text" class="form-control"   id="expectedQuantity" name="expectedQuantity" >
                                        </div>
                                        <div class="form-group mx-4 my-2">
                                            <label for="inventoryStatus" class="col-form-label mx-4" th:text="#{receipt.line.inventoryStatus}">Inventory Status:</label>
                                            <select class="form-control" id="inventoryStatus" name="inventoryStatus" data-variable="inventoryStatus"></select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Display all the receipt lines that already created for this receipt -->
                            <div class="card my-4">
                                <div class="card-header" id="receiptLineHeader" role="tab">
                                    <h5 class="mb-0">
                                        <a data-toggle="collapse" href="#receiptLineInfo" aria-expanded="true"
                                           aria-controls="receiptLineInfo" th:text="#{receipt.lines}">Receipt Line Info</a>
                                        <a class="badge badge-success float-right">Totally
                                            <span class="mx-1" th:if="${addTrailerFlowModel != null}"
                                                  th:text="${addTrailerFlowModel.currentReceipt != null && addTrailerFlowModel.currentReceipt.receiptLineList != null} ? ${#lists.size(addTrailerFlowModel.currentReceipt.receiptLineList)} : '0'"></span>
                                            <span class="mx-1" th:if="${addReceiptFlowModel != null}"
                                                  th:text="${addReceiptFlowModel.currentReceipt != null && addReceiptFlowModel.currentReceipt.receiptLineList != null} ? ${#lists.size(addReceiptFlowModel.currentReceipt.receiptLineList)} : '0'"></span>
                                            Lines
                                        </a>
                                    </h5>
                                </div>
                                <div class="collapse show" id="receiptLineInfo" role="tabpanel" aria-labelledby="receiptLineHeader">
                                    <div class="card-body">
                                        <table class="table table-striped table-bordered display nowrap table-selectable" style="width:100%"
                                               data-tabletype="datatable" data-init="true" data-scrollx="true" data-refresh="true"
                                               id="receiptLinesTable">
                                            <thead>
                                                <tr>
                                                    <td th:text="#{receipt.number}"></td>
                                                    <td th:text="#{receipt.line.number}"></td>
                                                    <td th:text="#{receipt.line.externalID}"></td>
                                                    <td th:text="#{item.number}"></td>
                                                    <td th:text="#{item.description}"></td>
                                                    <td th:text="#{receipt.line.expectedQuantity}"></td>
                                                    <td th:text="#{receipt.line.inventoryStatus}"></td>
                                                    <td></td>
                                                </tr>
                                            </thead>
                                            <tbody th:if="${addTrailerFlowModel != null and addTrailerFlowModel.getCurrentReceiptLinesList() != null and addTrailerFlowModel.getCurrentReceiptLinesList().size() > 0}">
                                                <tr th:each="receiptLine : ${addTrailerFlowModel.getCurrentReceiptLinesList()}" th:if="${not #strings.isEmpty(receiptLine.lineNumber)}">
                                                    <td th:text="${addTrailerFlowModel.currentReceipt.number}"></td>
                                                    <td th:text="${receiptLine.lineNumber}" data-fieldname="lineNumber"></td>
                                                    <td th:text="${receiptLine.externalID}" data-fieldname="externalID"></td>
                                                    <td th:text="${receiptLine.item.name}" data-fieldname="item"></td>
                                                    <td th:text="${receiptLine.item.description}" ></td>
                                                    <td th:text="${receiptLine.expectedQuantity}" data-fieldname="expectedQuantity"></td>
                                                    <td th:text="${receiptLine.inventoryStatus.name}" data-fieldname="inventoryStatus"></td>
                                                    <td>
                                                        <button type="submit" class="btn btn-sm btn-danger btn-remove-row"  name="_eventId_removeReceiptLine" th:data-receiptlinenumber="${receiptLine.lineNumber}" th:text="#{remove}">
                                                            Remove</button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tbody th:if="${addReceiptFlowModel != null and addReceiptFlowModel.getCurrentReceipt() != null and addReceiptFlowModel.getCurrentReceipt().getReceiptLineList() != null and addReceiptFlowModel.getCurrentReceipt().getReceiptLineList().size() > 0}">
                                                <tr th:each="receiptLine : ${addReceiptFlowModel.getCurrentReceipt().getReceiptLineList()}" th:if="${not #strings.isEmpty(receiptLine.lineNumber)}">
                                                    <td th:text="${addReceiptFlowModel.currentReceipt.number}"></td>
                                                    <td th:text="${receiptLine.lineNumber}" data-fieldname="lineNumber"></td>
                                                    <td th:text="${receiptLine.externalID}" data-fieldname="externalID"></td>
                                                    <td th:text="${receiptLine.item.name}" data-fieldname="item"></td>
                                                    <td th:text="${receiptLine.item.description}" ></td>
                                                    <td th:text="${receiptLine.expectedQuantity}" data-fieldname="expectedQuantity"></td>
                                                    <td th:text="${receiptLine.inventoryStatus.name}" data-fieldname="inventoryStatus"></td>
                                                    <td>
                                                        <button type="submit" class="btn btn-sm btn-danger btn-remove-row"  name="_eventId_removeReceiptLine" th:data-receiptlinenumber="${receiptLine.lineNumber}" th:text="#{remove}">
                                                            Remove</button>
                                                    </td>
                                                </tr>
                                            </tbody>

                                        </table>

                                    </div>
                                </div>
                            </div>



                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-sm btn-primary" name="_eventId_previous" th:text="#{step.previous}">
                                <i class="fa fa-dot-circle-o"></i> Previous</button>
                            <button type="submit" class="btn btn-sm btn-primary" name="_eventId_moreReceipt" th:if="${addTrailerFlowModel != null}"
                                    th:text="#{step.flow.trailer.saveAndMoreReceipt}">
                                <i class="fa fa-dot-circle-o"></i> Next</button>
                            <button type="submit" class="btn btn-sm btn-primary" name="_eventId_saveReceiptLine" th:text="#{step.flow.trailer.saveAndMoreReceiptLine}">
                                <i class="fa fa-dot-circle-o"></i> Next</button>
                            <button type="submit" class="btn btn-sm btn-primary" name="_eventId_confirmTrailer"  th:if="${addTrailerFlowModel != null}"
                                    th:text="#{step.flow.trailer.saveAndConfirmTrailer}" >
                                <i class="fa fa-dot-circle-o"></i> Next</button>
                            <button type="submit" class="btn btn-sm btn-primary" name="_eventId_confirmReceipt"  th:if="${addReceiptFlowModel != null}"
                                    th:text="#{step.flow.trailer.saveAndConfirmReceipt}" >
                                <i class="fa fa-dot-circle-o"></i> Next</button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </main>

    <aside th:replace="fragment/asidemenu :: aside-menu"></aside>
</div>
<footer th:replace="fragment/footer :: app-footer"></footer>

<script>
    $(document).ready(function() {
        // Allow the user to select a row from the Receipt display table and
        // then fill the receipt content into the text box
        var table = $('#receiptLinesTable').DataTable();

        $('#receiptLinesTable tbody').on( 'click', 'tr', function () {
            if ( !$(this).hasClass('selected') ) {
                table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');

                // Fill the selected row into the input box
                $(this).children("td").each(function(){
                    var key = $(this).data("fieldname");
                    var text = $(this).html();
                    console.log("select: " + key + " with value: " + text);
                    if (key != '') {
                        $("#" + key).val(text);
                    }
                });
            }
        });
    })

    $(".btn-remove-row").click(function(event){
        // When remove a receipt line, we will call webserver to remove it from current modal
        // and then remove it from display
        var button = $(this);
        $("#lineNumber").val(button.data("receiptlinenumber"));
    })

    $("#btnClearReceiptLineInfo").click(function(event){
        $("#lineNumber").val("");
        $("#externalID").val("");
        $("#item").val("");
        $("#expectedQuantity").val("");
        $("#inventoryStatus").val("");
    })

</script>
</body>
</html>
