<!DOCTYPE html>
<!--
* CoreUI - Free Bootstrap Admin Template
* @version v2.0.0
* @link https://coreui.io
* Copyright (c) 2018 creativeLabs Łukasz Holeczek
* Licensed under MIT (https://coreui.io/license)
-->

<!--
* gzhang - Warehouse Management System
* @version v0.0.1
* @link
* Copyright (c) 2018 Gary Zhang
* Licensed under MIT (https://github.com/gzhang1999/WarehouseManagement/blob/master/LICENSE)
-->

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragment/header :: common-head">
</head>
<body class="app header-fixed sidebar-fixed aside-menu-fixed sidebar-lg-show">

<div th:replace="fragment/topNav :: headerNav">
</div>
<div class="app-body">


    <div th:replace="fragment/leftNav :: sidebar">
    </div>
    <main class="main">
        <!-- Breadcrumb-->

        <ol th:replace="fragment/breadcrumb :: breadcrumb"></ol>

        <div class="container-fluid">
            <div class="animated fadeIn">
                <div class="card">
                    <div class="card-header">

                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="row px-3">
                                    <label for="cartonNumber" th:text="#{carton.number}">Carton Number:</label>
                                    <input type="text" class="mx-2" id="cartonNumber" name="cartonNumber" required>
                                </div>
                                <div class="row my-2  px-3">
                                    <label for="itemName"  th:text="#{item.name}">Item Name:</label>
                                    <input type="text" class="mx-2" id="itemName" name="itemName" >
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="auditResultMessage"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card card-accent-success">
                    <div class="card-body">
                        <!-- Grid Display -->
                        <div class="row">
                            <div class="col-md-9">
                                <div class="row">
                                    <div>
                                        <strong th:text="#{carton.audit.currentSequence}"></strong>
                                        <span id="currentAuditSequence" class="mx-2"></span>
                                    </div>
                                </div>
                                <table id = "cartonTable" class="table table-striped table-bordered display nowrap"
                                       style="width:100%" data-tabletype="datatable" data-init="true" data-scrollx="true">
                                    <thead>
                                        <tr>
                                            <td th:text="#{item.name}">Item Name</td>
                                            <td th:text="#{item.description}">Item Description</td>
                                            <td th:text="#{carton.audit.expectedQuantity}">Expected Quantity</td>
                                            <td th:text="#{carton.audit.auditQuantity}">Audit Quantity</td>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="col-md-3">
                                <div class="panel panel-primary">
                                    <div class="panel-heading">
                                        <h3 class="panel-title">Audit Result History</h3>
                                    </div>
                                    <div class="panel-body">
                                        <ul class="list-group"
                                            style="max-height:300px;margin-bottom: 10px;overflow:scroll; -webkit-overflow-scrolling: touch;">
                                            <li class="list-group-item"><strong>Result 1</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 2</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 3</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 4</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 5</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 6</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 7</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 8</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 9</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 10</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 11</strong>
                                            </li>
                                            <li class="list-group-item"><strong>Result 12</strong>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>


    <aside th:replace="fragment/asidemenu :: aside-menu"></aside>
</div>
<footer th:replace="fragment/footer :: app-footer"></footer>
<script>

    $("#cartonNumber").keypress( function(e) {

        if (e.keyCode == 13) {
            // valid the carton number and load the carton content
            var cartonNumber = $("#cartonNumber").val();
            var url = "/ws/outbound/cartonaudit"
            $.ajax({
                   url:url,
                   data : {
                       cartonNumber : cartonNumber
                   }
            })
             .done(function( res ) {
                     console.log(JSON.stringify(res));
                 if (res.status == 0) {
                     displaySuccessMessage("carton: " + cartonNumber + " audit started!");
                     fillCartonTable(res.data);
                     // move focus to the item number
                     $("#itemName").focus();

                     refreshAuditResultMessage();
                 }
                 else{
                     displayFailMessage(res.message, res.errorCode);
                     $("#cartonNumber").focus();
                 }
             });
        }
    });

    $("#cartonNumber").focus( function(e) {
        $(this).select();
    });

    $("#itemName").focus( function(e) {
        $(this).select();
    });

    var fillCartonTable = function(cartonAuditResult) {

        var table = $("#cartonTable").DataTable();

        if (cartonAuditResult.length == 0) {
            table.clear().draw();
            $("auditResultMessage").text("");
        }
        else {
            $("#currentAuditSequence").text = cartonAuditResult.id;
            table.clear();
            var htmlData = "";

            $.each(cartonAuditResult.cartonAuditLines, function(index, cartonAuditLine){
                htmlData +=
                        "<tr>" +
                        "    <td>" + cartonAuditLine.item.name + "</td>" +
                        "    <td>" + cartonAuditLine.item.description + "</td>" +
                        "    <td id='item-" + cartonAuditLine.item.name + "-expectedQuantity'>" + cartonAuditLine.expectedQuantity + "</td>" +
                        "    <td><input type='text' data-itemname='" + cartonAuditLine.item.name + "' value='" + cartonAuditLine.auditQuantity + "'></td>" +
                         "</tr>";
            });
            var html = $(htmlData.trim().replace(/\s+/g, " ").replace(/\<\/tr\> \<tr/g, '</tr><tr'));
            table.rows.add(html).draw();
        }
    }

    $("#itemName").keypress( function(e) {
        if (e.keyCode == 13) {
            var itemName = $("#itemName").val();
            var auditQuantityControls = $('[data-itemname="' + itemName + '"]');

            if(auditQuantityControls.length == 0) {
                displayFailMessage("Cannot find the item in this carton");
                $(this).focus();
            }

            auditQuantityControls.each(function(){
                console.log("$(this).val(): " + $(this).val());
                if ($(this).val() == "") {
                    $(this).val(1);
                }
                else {
                    $(this).val(parseInt($(this).val()) + 1);
                }
            });

            refreshAuditResultMessage();
            $("#itemName").focus();
        }
    });

    var refreshAuditResultMessage = function() {
        var auditQuantityControls = $("input[data-itemname]").filter(function () {
            return $.trim($(this).data("itemname")) != '';
        });

        var auditMatch = true;
        if(auditQuantityControls.length != 0) {
            auditQuantityControls.each(function(){
                var auditQuantityControl = $(this);
                var itemName = auditQuantityControl.data("itemname");
                var expectedQuantity = parseInt($("#item-" + itemName + "-expectedQuantity").html());
                var auditQuantity = parseInt(auditQuantityControl.val());
                console.log("itemName: " + itemName + ", expectedQuantity: " +  expectedQuantity + ", auditQuantity: " + auditQuantity);
                if (expectedQuantity != auditQuantity) {
                    auditMatch = false;
                }
            });
        }

        if (auditMatch == true) {
            $("auditResultMessage").html("DONE");
        }
        else {
            $("auditResultMessage").text("NOT match!!!!");
        }



    }

</script>
</body>
</html>
